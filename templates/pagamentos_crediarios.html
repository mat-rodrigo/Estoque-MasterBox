{% extends "base.html" %}

{% block title %}Pagamentos de Crediários - Sistema de Estoque{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="text-center">
            <i class="fas fa-credit-card text-success me-3"></i>
            Pagamentos de Crediários
        </h2>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-search me-2"></i>
                    Buscar Atacadista
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Buscar Atacadista:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="busca-atacadista" placeholder="Digite o nome ou CPF/CNPJ do atacadista...">
                        <button class="btn btn-outline-secondary" type="button" onclick="limparBuscaAtacadista()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="lista-atacadistas" class="mt-2" style="display: none;">
                        <div class="list-group" id="resultados-atacadistas"></div>
                    </div>
                    <div id="atacadista-selecionado" class="mt-2" style="display: none;">
                        <div class="alert alert-success">
                            <strong id="nome-atacadista"></strong><br>
                            <small id="info-atacadista"></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3" id="card-crediarios" style="display: none;">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>
                    Crediários Pendentes
                </h5>
            </div>
            <div class="card-body">
                <div id="lista-crediarios">
                    <p class="text-muted text-center">Carregando crediários...</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-warning text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-calculator me-2"></i>
                    Resumo Financeiro
                </h5>
            </div>
            <div class="card-body">
                <div id="resumo-financeiro">
                    <p class="text-muted text-center">Selecione um atacadista para ver o resumo</p>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-credit-card me-2"></i>
                    Crédito na Loja
                </h5>
            </div>
            <div class="card-body">
                <div id="credito-loja">
                    <p class="text-muted text-center">Selecione um atacadista para ver o crédito</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Pagamento -->
<div class="modal fade" id="modalPagamento" tabindex="-1" aria-labelledby="modalPagamentoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalPagamentoLabel">
                    <i class="fas fa-money-bill-wave me-2"></i>
                    Realizar Pagamento
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6>Informações do Crediário:</h6>
                    <p><strong>Atacadista:</strong> <span id="modal-atacadista-nome"></span></p>
                    <p><strong>Valor Total:</strong> <span id="modal-valor-total" class="text-primary"></span></p>
                    <p><strong>Valor Pago:</strong> <span id="modal-valor-pago" class="text-success"></span></p>
                    <p><strong>Valor Restante:</strong> <span id="modal-valor-restante" class="text-warning"></span></p>
                    <p><strong>Vencimento:</strong> <span id="modal-data-vencimento"></span></p>
                    <p><strong>Status:</strong> <span id="modal-status"></span></p>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Valor do Pagamento (R$):</label>
                    <input type="number" class="form-control" id="valor-pagamento" min="0.01" step="0.01" required>
                    <small class="form-text text-muted">Digite o valor que deseja pagar</small>
                </div>
                
                <div class="mb-3" id="opcoes-pagamento-credito" style="display: none;">
                    <label class="form-label">Forma de Pagamento:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="formaPagamento" id="formaDinheiro" value="dinheiro" checked>
                        <label class="form-check-label" for="formaDinheiro">
                            <i class="fas fa-money-bill-wave me-1"></i>
                            Dinheiro/Cartão
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="formaPagamento" id="formaCredito" value="credito">
                        <label class="form-check-label" for="formaCredito">
                            <i class="fas fa-credit-card me-1"></i>
                            Usar Crédito na Loja
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Observações (opcional):</label>
                    <textarea class="form-control" id="observacoes-pagamento" rows="3" placeholder="Observações sobre o pagamento..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="realizarPagamento()">
                    <i class="fas fa-check me-2"></i>
                    Confirmar Pagamento
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Histórico de Pagamentos -->
<div class="modal fade" id="modalHistorico" tabindex="-1" aria-labelledby="modalHistoricoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalHistoricoLabel">
                    <i class="fas fa-history me-2"></i>
                    Histórico de Transações
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6>Informações do Crediário:</h6>
                    <p><strong>Atacadista:</strong> <span id="historico-atacadista-nome"></span></p>
                    <p><strong>Valor Total:</strong> <span id="historico-valor-total" class="text-primary"></span></p>
                    <p><strong>Valor Pago:</strong> <span id="historico-valor-pago" class="text-success"></span></p>
                    <p><strong>Valor Restante:</strong> <span id="historico-valor-restante" class="text-warning"></span></p>
                    <p><strong>Status:</strong> <span id="historico-status"></span></p>
                </div>
                <div class="mb-3">
                    <h6>Produtos Comprados:</h6>
                    <div id="produtos-comprados">
                        <p class="text-muted text-center">Carregando produtos...</p>
                    </div>
                </div>
                <div class="mb-3">
                    <h6>Histórico de Pagamentos e Devoluções:</h6>
                    <div id="lista-pagamentos">
                        <p class="text-muted text-center">Carregando histórico...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Devolução -->
<div class="modal fade" id="modalDevolucao" tabindex="-1" aria-labelledby="modalDevolucaoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="modalDevolucaoLabel">
                    <i class="fas fa-undo me-2"></i>
                    Registrar Devolução
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6>Informações do Crediário:</h6>
                    <p><strong>Atacadista:</strong> <span id="devolucao-atacadista-nome"></span></p>
                    <p><strong>Valor Total:</strong> <span id="devolucao-valor-total" class="text-primary"></span></p>
                    <p><strong>Valor Pago:</strong> <span id="devolucao-valor-pago" class="text-success"></span></p>
                    <p><strong>Valor Restante:</strong> <span id="devolucao-valor-restante" class="text-warning"></span></p>
                    <p><strong>Status:</strong> <span id="devolucao-status"></span></p>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Produtos da Venda:</label>
                    <div id="produtos-venda-devolucao-tabela">
                        <p class="text-muted text-center">Carregando produtos...</p>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Produtos Selecionados para Devolução:</label>
                    <div id="produtos-selecionados-devolucao">
                        <p class="text-muted text-center">Nenhum produto selecionado</p>
                    </div>
                </div>
                
                <div class="mb-3" id="opcoes-devolucao-pago" style="display: none;">
                    <label class="form-label">Tipo de Devolução:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="tipoDevolucao" id="tipoCaixa" value="caixa" checked>
                        <label class="form-check-label" for="tipoCaixa">
                            <i class="fas fa-cash-register me-1"></i>
                            Receber o valor (retira do caixa diário)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="tipoDevolucao" id="tipoCredito" value="credito">
                        <label class="form-check-label" for="tipoCredito">
                            <i class="fas fa-credit-card me-1"></i>
                            Deixar como crédito na loja
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Observações (opcional):</label>
                    <textarea class="form-control" id="observacoes-devolucao" rows="3" placeholder="Observações sobre a devolução..."></textarea>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Importante:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Se o crediário estiver <strong>pendente</strong>, o valor será zerado</li>
                        <li>Se o crediário estiver <strong>pago</strong>, você pode escolher entre:</li>
                        <ul>
                            <li><strong>Receber o valor:</strong> O valor será retirado do caixa diário</li>
                            <li><strong>Crédito na loja:</strong> O valor ficará disponível como crédito para futuras compras</li>
                        </ul>
                        <li>Após a devolução, o crediário não poderá mais ser pago</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-warning" onclick="realizarDevolucao()">
                    <i class="fas fa-undo me-2"></i>
                    Confirmar Devolução
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let atacadistas = [];
let atacadistaSelecionado = null;
let crediariosAtacadista = [];
let crediarioSelecionado = null;
let produtosDisponiveisParaDevolucao = {};

$(document).ready(function() {
    console.log('=== PÁGINA DE PAGAMENTOS DE CREDIÁRIOS CARREGADA ===');
    carregarAtacadistas();
    
    // Verificar se há atacadista na URL
    const urlParams = new URLSearchParams(window.location.search);
    const atacadistaId = urlParams.get('atacadista');
    
    if (atacadistaId) {
        console.log('Atacadista pré-selecionado via URL:', atacadistaId);
        // Aguardar carregamento dos atacadistas e então selecionar
        setTimeout(function() {
            selecionarAtacadistaPorId(parseInt(atacadistaId));
        }, 500);
    } else {
        // Verificar se há atacadista no localStorage (vindo da página de clientes)
        const atacadistaLocalStorage = localStorage.getItem('atacadistaSelecionado');
        if (atacadistaLocalStorage) {
            console.log('Atacadista pré-selecionado via localStorage:', atacadistaLocalStorage);
            // Aguardar carregamento dos atacadistas e então selecionar
            setTimeout(function() {
                selecionarAtacadistaPorId(parseInt(atacadistaLocalStorage));
                // Limpar o localStorage após usar
                localStorage.removeItem('atacadistaSelecionado');
            }, 500);
        }
    }
    
    // Busca automática de atacadistas
    let timeoutBuscaAtacadista;
    $('#busca-atacadista').on('input', function() {
        clearTimeout(timeoutBuscaAtacadista);
        const busca = $(this).val().trim();
        
        timeoutBuscaAtacadista = setTimeout(function() {
            buscarAtacadistas(busca);
        }, 300);
    });
    
    // Evento para valor do pagamento
    $('#valor-pagamento').on('input', function() {
        const valorPagamento = parseFloat($(this).val()) || 0;
        const valorRestante = parseFloat($('#modal-valor-restante').text().replace('R$ ', '').replace(',', '.')) || 0;
        
        if (valorPagamento > valorRestante) {
            $(this).addClass('is-invalid');
            $(this).next('.invalid-feedback').remove();
            $(this).after('<div class="invalid-feedback">O valor não pode ser maior que o valor restante</div>');
        } else {
            $(this).removeClass('is-invalid');
            $(this).next('.invalid-feedback').remove();
        }
    });
    
    // Atualização automática do resumo financeiro a cada 30 segundos
    setInterval(function() {
        if (atacadistaSelecionado) {
            console.log('Atualizando resumo financeiro automaticamente...');
            calcularResumoFinanceiro();
        }
    }, 30000); // 30 segundos
    
    // Atualizar resumo quando a página ganhar foco
    $(window).on('focus', function() {
        if (atacadistaSelecionado) {
            console.log('Página ganhou foco - atualizando resumo financeiro...');
            carregarCrediariosAtacadista(atacadistaSelecionado.id);
        }
    });
});

function carregarAtacadistas() {
    $.get('/api/clientes', function(data) {
        atacadistas = data.filter(c => c.tipo === 'Atacadista');
        console.log('Atacadistas carregados:', atacadistas.length);
    }).fail(function(xhr, status, error) {
        console.error('Erro ao carregar atacadistas:', error);
    });
}

function buscarAtacadistas(termo) {
    if (!termo) {
        $('#lista-atacadistas').hide();
        return;
    }
    
    const resultados = atacadistas.filter(a => 
        a.nome.toLowerCase().includes(termo.toLowerCase()) ||
        (a.cpf_cnpj && a.cpf_cnpj.includes(termo))
    );
    
    const container = $('#resultados-atacadistas');
    container.empty();
    
    if (resultados.length === 0) {
        container.append('<div class="list-group-item text-muted">Nenhum atacadista encontrado</div>');
    } else {
        resultados.forEach(function(atacadista) {
            const item = `
                <div class="list-group-item list-group-item-action" onclick="selecionarAtacadista(${atacadista.id})">
                    <strong>${atacadista.nome}</strong><br>
                    <small class="text-muted">${atacadista.cpf_cnpj || 'CPF/CNPJ não informado'}</small>
                </div>
            `;
            container.append(item);
        });
    }
    
    $('#lista-atacadistas').show();
}

function selecionarAtacadista(id) {
    atacadistaSelecionado = atacadistas.find(a => a.id === id);
    if (atacadistaSelecionado) {
        $('#nome-atacadista').text(atacadistaSelecionado.nome);
        $('#info-atacadista').text(`CPF/CNPJ: ${atacadistaSelecionado.cpf_cnpj || 'Não informado'}`);
        $('#atacadista-selecionado').show();
        $('#lista-atacadistas').hide();
        $('#busca-atacadista').val(atacadistaSelecionado.nome);
        
        // Carregar crediários do atacadista
        carregarCrediariosAtacadista(id);
        calcularResumoFinanceiro();
    }
}

function selecionarAtacadistaPorId(id) {
    const atacadista = atacadistas.find(a => a.id === id);
    if (atacadista) {
        selecionarAtacadista(id);
    } else {
        console.log('Atacadista não encontrado, tentando novamente...');
        // Tentar novamente após um delay se os atacadistas ainda não foram carregados
        setTimeout(function() {
            selecionarAtacadistaPorId(id);
        }, 1000);
    }
}

function limparBuscaAtacadista() {
    $('#busca-atacadista').val('');
    $('#lista-atacadistas').hide();
    $('#atacadista-selecionado').hide();
    $('#card-crediarios').hide();
    atacadistaSelecionado = null;
    $('#resumo-financeiro').html('<p class="text-muted text-center">Selecione um atacadista para ver o resumo</p>');
}

function carregarCrediariosAtacadista(clienteId) {
    $.get(`/api/crediarios/cliente/${clienteId}`, function(data) {
        crediariosAtacadista = data;
        const container = $('#lista-crediarios');
        
        if (data.length === 0) {
            container.html('<p class="text-muted text-center">Nenhum crediário pendente</p>');
            $('#card-crediarios').show();
            // Atualizar resumo mesmo sem crediários
            calcularResumoFinanceiro();
            return;
        }
        
        let html = '<div class="list-group">';
        data.forEach(function(crediario) {
            const statusClass = crediario.status === 'Pago' ? 'list-group-item-success' : 
                              crediario.status === 'Atrasado' ? 'list-group-item-danger' : 
                              crediario.status === 'Retorno' ? 'list-group-item-primary' : 'list-group-item-warning';
            
            const statusBadge = crediario.status === 'Pago' ? 'success' : 
                              crediario.status === 'Atrasado' ? 'danger' : 
                              crediario.status === 'Retorno' ? 'primary' : 'warning';
            
            html += `
                <div class="list-group-item ${statusClass}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between">
                                <strong>R$ ${crediario.valor_restante.toFixed(2).replace('.', ',')}</strong>
                                <span class="badge bg-${statusBadge}">${crediario.status}</span>
                            </div>
                            <small class="text-muted">Vencimento: ${crediario.data_vencimento}</small><br>
                            <small class="text-muted">Criado em: ${crediario.data_criacao}</small>
                            ${(crediario.valor_total === 0 && crediario.tem_devolucao) ? '<br><small class="text-danger"><i class="fas fa-undo me-1"></i>Completamente Devolvido</small>' : ''}
                        </div>
                        <div class="ms-3">
                            <button type="button" class="btn btn-sm btn-info me-1" onclick="verHistoricoPagamentos(${crediario.id})">
                                <i class="fas fa-history me-1"></i>Histórico
                            </button>
                            ${!(crediario.completamente_devolvido) && crediario.valor_restante > 0 ? `
                                <button type="button" class="btn btn-sm btn-success me-1" onclick="abrirModalPagamento(${crediario.id})">
                                    <i class="fas fa-money-bill-wave me-1"></i>Pagar
                                </button>
                            ` : ''}
                            ${!crediario.completamente_devolvido ? `
                                <button type="button" class="btn btn-sm btn-warning" onclick="abrirModalDevolucao(${crediario.id})">
                                    <i class="fas fa-undo me-1"></i>Devolver
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        container.html(html);
        $('#card-crediarios').show();
        
        // Atualizar resumo financeiro e crédito na loja automaticamente
        calcularResumoFinanceiro();
        carregarCreditoLoja(clienteId);
    }).fail(function(xhr, status, error) {
        console.error('Erro ao carregar crediários:', error);
        $('#lista-crediarios').html('<p class="text-danger">Erro ao carregar crediários</p>');
    });
}

function calcularResumoFinanceiro() {
    if (!atacadistaSelecionado || crediariosAtacadista.length === 0) {
        $('#resumo-financeiro').html('<p class="text-muted text-center">Selecione um atacadista para ver o resumo</p>');
        return;
    }
    
    // Mostrar indicador de atualização
    const resumoContainer = $('#resumo-financeiro');
    const loadingHtml = `
        <div class="text-center">
            <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                <span class="visually-hidden">Atualizando...</span>
            </div>
            <small class="text-muted">Atualizando resumo...</small>
        </div>
    `;
    resumoContainer.html(loadingHtml);
    
    const totalDevido = crediariosAtacadista.reduce((sum, c) => sum + c.valor_restante, 0);
    const totalPago = crediariosAtacadista.reduce((sum, c) => sum + c.valor_pago, 0);
    const crediariosPendentes = crediariosAtacadista.filter(c => c.status === 'Pendente' || c.status === 'Atrasado');
    const crediariosAtrasados = crediariosAtacadista.filter(c => c.status === 'Atrasado').length;
    
    // Pequeno delay para mostrar o indicador de atualização
    setTimeout(function() {
        let html = `
            <div class="text-center mb-3">
                <h6>Resumo do Atacadista</h6>
                <p class="text-muted">${atacadistaSelecionado.nome}</p>
            </div>
            <div class="row text-center">
                <div class="col-6">
                    <div class="border-end">
                        <h5 class="text-primary mb-0">R$ ${totalDevido.toFixed(2).replace('.', ',')}</h5>
                        <small class="text-muted">Total Devido</small>
                    </div>
                </div>
                <div class="col-6">
                    <h5 class="text-success mb-0">R$ ${totalPago.toFixed(2).replace('.', ',')}</h5>
                    <small class="text-muted">Total Pago</small>
                </div>
            </div>
            <hr>
            <div class="row text-center">
                <div class="col-6">
                    <h6 class="text-warning mb-0">${crediariosPendentes.length}</h6>
                    <small class="text-muted">Crediários Pendentes</small>
                </div>
                <div class="col-6">
                    <h6 class="text-danger mb-0">${crediariosAtrasados}</h6>
                    <small class="text-muted">Crediários Atrasados</small>
                </div>
            </div>
        `;
        resumoContainer.html(html);
    }, 300);
}

function carregarCreditoLoja(clienteId) {
    if (!clienteId) {
        $('#credito-loja').html('<p class="text-muted text-center">Selecione um atacadista para ver o crédito</p>');
        return;
    }
    
    $.get(`/api/credito-loja/cliente/${clienteId}`).done(function(data) {
        const container = $('#credito-loja');
        
        if (data.total_credito === 0) {
            container.html(`
                <div class="text-center">
                    <h6 class="text-muted">R$ 0,00</h6>
                    <small class="text-muted">Nenhum crédito disponível</small>
                </div>
            `);
            return;
        }
        
        let html = `
            <div class="text-center mb-3">
                <h4 class="text-info mb-0">R$ ${data.total_credito.toFixed(2).replace('.', ',')}</h4>
                <small class="text-muted">Crédito Disponível</small>
            </div>
            <div class="mt-3">
                <h6>Histórico de Créditos:</h6>
                <div class="list-group list-group-flush">
        `;
        
        data.creditos.forEach(function(credito) {
            const valorClass = credito.valor > 0 ? 'text-success' : 'text-danger';
            const icon = credito.valor > 0 ? 'plus' : 'minus';
            
            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                    <div>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-${icon} ${valorClass} me-2"></i>
                            <span class="${valorClass}">R$ ${Math.abs(credito.valor).toFixed(2).replace('.', ',')}</span>
                        </div>
                        <small class="text-muted">${credito.data_criacao}</small>
                        ${credito.observacoes ? `<br><small class="text-muted">${credito.observacoes}</small>` : ''}
                    </div>
                    <small class="text-muted">${credito.origem.replace('_', ' ')}</small>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
        
        container.html(html);
    }).fail(function(xhr, status, error) {
        console.error('Erro ao carregar crédito na loja:', error);
        $('#credito-loja').html('<p class="text-danger">Erro ao carregar crédito</p>');
    });
}

function abrirModalPagamento(crediarioId) {
    crediarioSelecionado = crediariosAtacadista.find(c => c.id === crediarioId);
    if (!crediarioSelecionado) {
        alert('Crediário não encontrado!');
        return;
    }
    
    $('#modal-atacadista-nome').text(atacadistaSelecionado.nome);
    $('#modal-valor-total').text('R$ ' + crediarioSelecionado.valor_total.toFixed(2).replace('.', ','));
    $('#modal-valor-pago').text('R$ ' + (crediarioSelecionado.valor_total - crediarioSelecionado.valor_restante).toFixed(2).replace('.', ','));
    $('#modal-valor-restante').text('R$ ' + crediarioSelecionado.valor_restante.toFixed(2).replace('.', ','));
    $('#modal-data-vencimento').text(crediarioSelecionado.data_vencimento);
    $('#modal-status').text(crediarioSelecionado.status);
    
    // Definir valor máximo do pagamento
    $('#valor-pagamento').attr('max', crediarioSelecionado.valor_restante);
    $('#valor-pagamento').val(crediarioSelecionado.valor_restante);
    $('#observacoes-pagamento').val('');
    
    // Verificar se há crédito disponível
    $.get(`/api/credito-loja/cliente/${atacadistaSelecionado.id}`).done(function(data) {
        if (data.total_credito > 0) {
            $('#opcoes-pagamento-credito').show();
            // Resetar seleção para dinheiro
            $('#formaDinheiro').prop('checked', true);
        } else {
            $('#opcoes-pagamento-credito').hide();
        }
    }).fail(function() {
        $('#opcoes-pagamento-credito').hide();
    });
    
    $('#modalPagamento').modal('show');
}

function realizarPagamento() {
    const valorPagamento = parseFloat($('#valor-pagamento').val()) || 0;
    const observacoes = $('#observacoes-pagamento').val();
    const formaPagamento = $('input[name="formaPagamento"]:checked').val();
    
    if (valorPagamento <= 0) {
        alert('Digite um valor válido para o pagamento!');
        return;
    }
    
    if (valorPagamento > crediarioSelecionado.valor_restante) {
        alert('O valor do pagamento não pode ser maior que o valor restante!');
        return;
    }
    
    // Mostrar loading
    $('#modalPagamento .btn-success').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Processando...');
    
    if (formaPagamento === 'credito') {
        // Usar crédito na loja
        const dadosCredito = {
            valor: valorPagamento,
            crediario_id: crediarioSelecionado.id,
            observacoes: observacoes
        };
        
        $.ajax({
            url: `/api/credito-loja/cliente/${atacadistaSelecionado.id}/usar`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(dadosCredito),
            success: function(response) {
                console.log('Pagamento com crédito realizado:', response);
                
                // Fechar modal
                $('#modalPagamento').modal('hide');
                
                // Mostrar mensagem de sucesso
                mostrarMensagemSucesso('Pagamento com crédito realizado com sucesso!');
                
                // Recarregar crediários, resumo e crédito automaticamente
                if (atacadistaSelecionado) {
                    carregarCrediariosAtacadista(atacadistaSelecionado.id);
                }
                
                // Resetar botão
                $('#modalPagamento .btn-success').prop('disabled', false).html('<i class="fas fa-check me-2"></i>Confirmar Pagamento');
            },
            error: function(xhr, status, error) {
                console.error('Erro ao realizar pagamento com crédito:', error);
                alert('Erro ao realizar pagamento com crédito: ' + error);
                
                // Resetar botão
                $('#modalPagamento .btn-success').prop('disabled', false).html('<i class="fas fa-check me-2"></i>Confirmar Pagamento');
            }
        });
    } else {
        // Pagamento normal
        const dadosPagamento = {
            valor_pago: valorPagamento
        };
        
        if (observacoes) {
            dadosPagamento.observacoes = observacoes;
        }
        
        $.ajax({
            url: `/api/crediarios/${crediarioSelecionado.id}/pagar`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(dadosPagamento),
            success: function(response) {
                console.log('Pagamento realizado:', response);
                
                // Fechar modal
                $('#modalPagamento').modal('hide');
                
                // Mostrar mensagem de sucesso
                mostrarMensagemSucesso('Pagamento realizado com sucesso!');
                
                // Recarregar crediários e resumo automaticamente
                if (atacadistaSelecionado) {
                    carregarCrediariosAtacadista(atacadistaSelecionado.id);
                }
                
                // Resetar botão
                $('#modalPagamento .btn-success').prop('disabled', false).html('<i class="fas fa-check me-2"></i>Confirmar Pagamento');
            },
            error: function(xhr, status, error) {
                console.error('Erro ao realizar pagamento:', error);
                alert('Erro ao realizar pagamento: ' + error);
                
                // Resetar botão
                $('#modalPagamento .btn-success').prop('disabled', false).html('<i class="fas fa-check me-2"></i>Confirmar Pagamento');
            }
        });
    }
}

function verHistoricoPagamentos(crediarioId) {
    // Buscar informações detalhadas do crediário
    $.get(`/api/crediarios/${crediarioId}`, function(crediario) {
        $('#historico-atacadista-nome').text(crediario.cliente_nome);
        $('#historico-valor-total').text('R$ ' + crediario.valor_total.toFixed(2).replace('.', ','));
        $('#historico-valor-pago').text('R$ ' + crediario.valor_pago.toFixed(2).replace('.', ','));
        $('#historico-valor-restante').text('R$ ' + crediario.valor_restante.toFixed(2).replace('.', ','));
        $('#historico-status').text(crediario.status);
        
        // Produtos comprados
        const produtosContainer = $('#produtos-comprados');
        if (crediario.produtos && crediario.produtos.length > 0) {
            let html = '<div class="table-responsive"><table class="table table-sm">';
            html += '<thead><tr><th>Produto</th><th>Qtd</th><th>Valor Unit.</th><th>Total</th></tr></thead><tbody>';
            crediario.produtos.forEach(function(produto) {
                const total = produto.quantidade * produto.valor_unitario;
                html += `
                    <tr>
                        <td>${produto.nome}</td>
                        <td>${produto.quantidade}</td>
                        <td>R$ ${produto.valor_unitario.toFixed(2).replace('.', ',')}</td>
                        <td>R$ ${total.toFixed(2).replace('.', ',')}</td>
                    </tr>
                `;
            });
            html += '</tbody></table></div>';
            produtosContainer.html(html);
        } else {
            produtosContainer.html('<p class="text-muted text-center">Nenhum produto registrado</p>');
        }
        
        // Carregar histórico de pagamentos e devoluções
        Promise.all([
            $.get(`/api/crediarios/${crediarioId}/pagamentos`),
            $.get(`/api/crediarios/${crediarioId}/devolucoes`)
        ]).then(function([pagamentos, devolucoes]) {
            const historicoContainer = $('#lista-pagamentos');
            
            // Combinar pagamentos e devoluções
            const todasTransacoes = [];
            
            // Adicionar pagamentos
            pagamentos.forEach(function(pagamento) {
                todasTransacoes.push({
                    tipo: 'pagamento',
                    data: pagamento.data_pagamento,
                    valor: pagamento.valor_pago,
                    observacoes: pagamento.observacoes,
                    timestamp: new Date(pagamento.data_pagamento.split(' ')[0].split('/').reverse().join('-') + ' ' + pagamento.data_pagamento.split(' ')[1])
                });
            });
            
            // Adicionar devoluções
            devolucoes.forEach(function(devolucao) {
                todasTransacoes.push({
                    tipo: 'devolucao',
                    data: devolucao.data_devolucao,
                    valor: devolucao.valor_devolvido,
                    observacoes: devolucao.observacoes,
                    produtos_devolvidos: devolucao.produtos_devolvidos,
                    timestamp: new Date(devolucao.data_devolucao.split(' ')[0].split('/').reverse().join('-') + ' ' + devolucao.data_devolucao.split(' ')[1])
                });
            });
            
            // Ordenar por data (mais recente primeiro)
            todasTransacoes.sort((a, b) => b.timestamp - a.timestamp);
            
            if (todasTransacoes.length === 0) {
                historicoContainer.html('<p class="text-muted text-center">Nenhuma transação registrada</p>');
                return;
            }
            
            let html = '<div class="list-group">';
            todasTransacoes.forEach(function(transacao) {
                const isPagamento = transacao.tipo === 'pagamento';
                const bgClass = isPagamento ? 'list-group-item-success' : 'list-group-item-warning';
                const icon = isPagamento ? 'fas fa-money-bill-wave' : 'fas fa-undo';
                const textClass = isPagamento ? 'text-success' : 'text-warning';
                const prefix = isPagamento ? '+' : '-';
                
                html += `
                    <div class="list-group-item ${bgClass}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center">
                                    <i class="${icon} me-2"></i>
                                    <strong>${isPagamento ? 'Pagamento' : 'Devolução'}</strong>
                                    <span class="badge bg-${isPagamento ? 'success' : 'warning'} ms-2">${transacao.data}</span>
                                </div>
                                <div class="mt-1">
                                    <span class="${textClass} fw-bold">${prefix} R$ ${transacao.valor.toFixed(2).replace('.', ',')}</span>
                                </div>
                                ${transacao.observacoes ? `<small class="text-muted">${transacao.observacoes}</small>` : ''}
                                ${transacao.produtos_devolvidos ? `
                                    <div class="mt-2">
                                        <small class="text-muted"><strong>Produtos devolvidos:</strong></small><br>
                                        <small class="text-muted">${formatarProdutosDevolvidos(transacao.produtos_devolvidos)}</small>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            historicoContainer.html(html);
        }).catch(function(error) {
            console.error('Erro ao carregar histórico:', error);
            $('#lista-pagamentos').html('<p class="text-danger">Erro ao carregar histórico de transações</p>');
        });
        
        $('#modalHistorico').modal('show');
    }).fail(function(xhr, status, error) {
        console.error('Erro ao carregar crediário:', error);
        alert('Erro ao carregar informações do crediário');
    });
}

function abrirModalDevolucao(crediarioId) {
    crediarioSelecionado = crediariosAtacadista.find(c => c.id === crediarioId);
    if (!crediarioSelecionado) {
        alert('Crediário não encontrado!');
        return;
    }

    $('#devolucao-atacadista-nome').text(atacadistaSelecionado.nome);
    $('#devolucao-valor-total').text('R$ ' + crediarioSelecionado.valor_total.toFixed(2).replace('.', ','));
    $('#devolucao-valor-pago').text('R$ ' + crediarioSelecionado.valor_pago.toFixed(2).replace('.', ','));
    $('#devolucao-valor-restante').text('R$ ' + crediarioSelecionado.valor_restante.toFixed(2).replace('.', ','));
    $('#devolucao-status').text(crediarioSelecionado.status);
    
    // Mostrar opções de devolução apenas se o crediário está pago
    if (crediarioSelecionado.status === 'Pago' && crediarioSelecionado.valor_pago > 0) {
        $('#opcoes-devolucao-pago').show();
        // Resetar seleção para caixa
        $('#tipoCaixa').prop('checked', true);
    } else {
        $('#opcoes-devolucao-pago').hide();
    }

    // Buscar produtos da venda e devoluções já realizadas
    Promise.all([
        $.get(`/api/vendas/produtos/${crediarioSelecionado.venda_id}`),
        $.get(`/api/crediarios/${crediarioSelecionado.id}/devolucoes`)
    ]).then(function([produtos, devolucoes]) {
        // Calcular saldo de cada produto
        const devolvidosPorId = {};
        devolucoes.forEach(function(dev) {
            try {
                const lista = JSON.parse(dev.produtos_devolvidos);
                lista.forEach(function(p) {
                    devolvidosPorId[p.id] = (devolvidosPorId[p.id] || 0) + p.quantidade;
                });
            } catch(e) {}
        });
        produtosDisponiveisParaDevolucao = {};
        // Tabela de produtos da venda (apenas os que ainda podem ser devolvidos)
        const produtosVendaContainer = $('#produtos-venda-devolucao-tabela');
        if (produtos && produtos.length > 0) {
            let html = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Produto</th><th>Qtd Vendida</th><th>Qtd Devolvida</th><th>Qtd Disponível</th><th>Valor Unit.</th><th>Qtd a Devolver</th><th></th></tr></thead><tbody>';
            produtos.forEach(function(prod) {
                const qtdDevolvida = devolvidosPorId[prod.id] || 0;
                const qtdDisponivel = prod.quantidade - qtdDevolvida;
                produtosDisponiveisParaDevolucao[prod.id] = {
                    nome: prod.nome,
                    valor_unitario: prod.valor_unitario,
                    qtdDisponivel: qtdDisponivel
                };
                html += `<tr>
                    <td>${prod.nome}</td>
                    <td>${prod.quantidade}</td>
                    <td>${qtdDevolvida}</td>
                    <td>${qtdDisponivel > 0 ? qtdDisponivel : 0}</td>
                    <td>R$ ${prod.valor_unitario.toFixed(2).replace('.', ',')}</td>
                    <td>${qtdDisponivel > 0 ? `<input type='number' min='1' max='${qtdDisponivel}' value='1' id='qtd-dev-${prod.id}' style='width:60px;' class='form-control form-control-sm' />` : ''}</td>
                    <td>${qtdDisponivel > 0 ? `<button type='button' class='btn btn-sm btn-outline-primary' onclick='adicionarProdutoDevolucao(${prod.id})'><i class="fas fa-plus-circle"></i></button>` : ''}</td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            produtosVendaContainer.html(html);
        } else {
            produtosVendaContainer.html('<p class="text-muted text-center">Nenhum produto registrado para esta venda.</p>');
        }
    });

    // Limpar produtos selecionados para devolução
    $('#produtos-selecionados-devolucao').empty();
    $('#produtos-selecionados-devolucao').html('<p class="text-muted text-center">Nenhum produto selecionado</p>');
    $('#observacoes-devolucao').val('');
    $('#modalDevolucao').modal('show');
}

function adicionarProdutoDevolucao(produtoId) {
    const info = produtosDisponiveisParaDevolucao[produtoId];
    if (!info || info.qtdDisponivel <= 0) {
        alert('Este produto já foi totalmente devolvido.');
        return;
    }
    const qtdInput = $(`#qtd-dev-${produtoId}`);
    let qtd = parseInt(qtdInput.val());
    if (isNaN(qtd) || qtd < 1) qtd = 1;
    if (qtd > info.qtdDisponivel) qtd = info.qtdDisponivel;
    const produtoSelecionado = $('#produtos-selecionados-devolucao').find(`.list-group-item[data-produto-id="${produtoId}"]`);
    if (produtoSelecionado.length === 0) {
        // Remover frase se for o primeiro produto
        $('#produtos-selecionados-devolucao p.text-muted').remove();
        const itemHtml = `
            <div class="list-group-item d-flex justify-content-between align-items-center" data-produto-id="${produtoId}">
                <div>
                    <strong>${info.nome}</strong><br>
                    <small class="text-muted">Qtd: ${qtd}, Valor: R$ ${(info.valor_unitario).toFixed(2).replace('.', ',')}</small>
                </div>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerProdutoDevolucao(${produtoId})">
                        <i class="fas fa-times-circle"></i>
                    </button>
                </div>
            </div>
        `;
        $('#produtos-selecionados-devolucao').append(itemHtml);
    } else {
        alert('Este produto já foi selecionado para devolução.');
    }
}

function removerProdutoDevolucao(produtoId) {
    $('#produtos-selecionados-devolucao').find(`.list-group-item[data-produto-id="${produtoId}"]`).remove();
    if ($('#produtos-selecionados-devolucao').find('.list-group-item').length === 0) {
        $('#produtos-selecionados-devolucao').html('<p class="text-muted text-center">Nenhum produto selecionado</p>');
    }
}

function realizarDevolucao() {
    const produtosSelecionados = $('#produtos-selecionados-devolucao').find('.list-group-item');
    const produtosParaDevolucao = [];
    let valorDevolucao = 0;

    produtosSelecionados.each(function() {
        const produtoId = $(this).data('produto-id');
        const info = produtosDisponiveisParaDevolucao[produtoId];
        const qtdInput = $(`#qtd-dev-${produtoId}`);
        let qtd = 1;
        if (qtdInput.length > 0) {
            qtd = parseInt(qtdInput.val());
            if (isNaN(qtd) || qtd < 1) qtd = 1;
            if (qtd > info.qtdDisponivel) qtd = info.qtdDisponivel;
        } else {
            // Se não encontrar input, pega do texto do item
            const txt = $(this).find('small').text();
            const match = txt.match(/Qtd: (\d+)/);
            if (match) qtd = parseInt(match[1]);
        }
        produtosParaDevolucao.push({
            id: produtoId,
            nome: info.nome,
            quantidade: qtd,
            valor_unitario: info.valor_unitario
        });
        valorDevolucao += info.valor_unitario * qtd;
    });

    if (produtosParaDevolucao.length === 0) {
        alert('Selecione pelo menos um produto para devolução!');
        return;
    }

    const observacoesDevolucao = $('#observacoes-devolucao').val();

    // Verificar tipo de devolução se o crediário está pago
    let tipoDevolucao = 'caixa';
    if (crediarioSelecionado.status === 'Pago' && crediarioSelecionado.valor_pago > 0) {
        tipoDevolucao = $('input[name="tipoDevolucao"]:checked').val();
    }

    const dadosDevolucao = {
        valor_devolvido: valorDevolucao,
        produtos_devolvidos: JSON.stringify(produtosParaDevolucao),
        observacoes: observacoesDevolucao,
        tipo_devolucao: tipoDevolucao
    };

    // Mostrar loading
    $('#modalDevolucao .btn-warning').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Processando...');

    $.ajax({
        url: `/api/crediarios/${crediarioSelecionado.id}/devolver`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(dadosDevolucao),
        success: function(response) {
            console.log('Devolução realizada:', response);
            
            // Fechar modal
            $('#modalDevolucao').modal('hide');
            
            // Mostrar mensagem de sucesso
            mostrarMensagemSucesso('Devolução realizada com sucesso!');
            
            // Recarregar crediários e resumo automaticamente
            if (atacadistaSelecionado) {
                carregarCrediariosAtacadista(atacadistaSelecionado.id);
            }
            
            // Resetar botão
            $('#modalDevolucao .btn-warning').prop('disabled', false).html('<i class="fas fa-undo me-2"></i>Confirmar Devolução');
        },
        error: function(xhr, status, error) {
            console.error('Erro ao realizar devolução:', error);
            alert('Erro ao realizar devolução: ' + error);
            
            // Resetar botão
            $('#modalDevolucao .btn-warning').prop('disabled', false).html('<i class="fas fa-undo me-2"></i>Confirmar Devolução');
        }
    });
}

function mostrarMensagemSucesso(mensagem) {
    // Criar toast de sucesso
    const toastHtml = `
        <div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-check-circle me-2"></i>${mensagem}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    // Adicionar toast ao container
    if ($('#toast-container').length === 0) {
        $('body').append('<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>');
    }
    
    $('#toast-container').append(toastHtml);
    
    // Mostrar o último toast adicionado
    const toast = $('#toast-container .toast').last();
    const bsToast = new bootstrap.Toast(toast[0]);
    bsToast.show();
    
    // Remover toast após ser fechado
    toast.on('hidden.bs.toast', function() {
        $(this).remove();
    });
}

function atualizarResumoManual() {
    if (atacadistaSelecionado) {
        console.log('Atualização manual do resumo financeiro...');
        carregarCrediariosAtacadista(atacadistaSelecionado.id);
        mostrarMensagemSucesso('Resumo atualizado com sucesso!');
    }
}

function formatarProdutosDevolvidos(produtosJson) {
    try {
        const produtos = JSON.parse(produtosJson);
        if (produtos && produtos.length > 0) {
            return produtos.map(p => `${p.nome} (Qtd: ${p.quantidade}, Valor: R$ ${p.valor_unitario.toFixed(2).replace('.', ',')})`).join(', ');
        }
        return 'Nenhum produto devolvido';
    } catch (e) {
        console.error('Erro ao formatar produtos devolvidos:', e);
        return 'Produtos inválidos';
    }
}
</script>

<style>
.list-group-item-action {
    cursor: pointer;
}

.list-group-item-action:hover {
    background-color: #f8f9fa;
}

body.dark-mode .list-group-item-action:hover {
    background-color: #404040;
}
</style>
{% endblock %} 