{% extends "base.html" %}

{% block title %}Vendas Simples - Sistema de Estoque{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="text-center">
            <i class="fas fa-shopping-cart text-success me-3"></i>
            Vendas Simples
        </h2>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-plus-circle me-2"></i>
                    Nova Venda
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Status do Carregamento:</label>
                    <div id="status-produtos" class="alert alert-info">
                        Carregando produtos...
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Produto:</label>
                    <select class="form-select" id="produto-select">
                        <option value="">Selecione um produto</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Quantidade:</label>
                    <input type="number" class="form-control" id="quantidade" min="1" value="1">
                </div>
                
                <div class="mb-3">
                    <button type="button" class="btn btn-primary" onclick="adicionarProduto()">
                        <i class="fas fa-plus me-2"></i>
                        Adicionar Produto
                    </button>
                </div>
                
                <hr>
                
                <div class="mb-3">
                    <h6>Produtos Selecionados:</h6>
                    <div id="lista-produtos" class="border rounded p-2" style="min-height: 100px;">
                        <p class="text-muted text-center mb-0">Nenhum produto selecionado</p>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Tipo de Pagamento:</label>
                    <select class="form-control" id="tipo-pagamento">
                        <option value="">Selecione o tipo de pagamento</option>
                        <option value="Espécie">Espécie</option>
                        <option value="Pix">Pix</option>
                        <option value="Cartão de Débito">Cartão de Débito</option>
                        <option value="Cartão de Crédito">Cartão de Crédito</option>
                        <option value="Parcelamento">Parcelamento</option>
                        <option value="Complemento">Complemento</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Cliente (opcional):</label>
                    <input type="text" class="form-control" id="cliente" placeholder="Nome do cliente">
                </div>
                
                <div class="mb-3">
                    <h5>Total: <span id="total" class="text-success">R$ 0,00</span></h5>
                </div>
                
                <button type="button" class="btn btn-success" onclick="finalizarVenda()">
                    <i class="fas fa-check me-2"></i>
                    Finalizar Venda
                </button>
                
                <button type="button" class="btn btn-secondary ms-2" onclick="recarregarProdutos()">
                    <i class="fas fa-sync-alt me-2"></i>
                    Recarregar Produtos
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>
                    Histórico de Vendas
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="tabela-vendas">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Cliente</th>
                                <th>Produtos</th>
                                <th>Valor</th>
                                <th>Pagamento</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin me-2"></i>
                                    Carregando vendas...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let produtos = [];
let vendas = [];
let produtosSelecionados = [];

$(document).ready(function() {
    console.log('=== PÁGINA DE VENDAS SIMPLES CARREGADA ===');
    console.log('jQuery disponível:', typeof $ !== 'undefined');
    console.log('Elementos encontrados:');
    console.log('- #produto-select:', $('#produto-select').length);
    console.log('- #status-produtos:', $('#status-produtos').length);
    console.log('- #tabela-vendas:', $('#tabela-vendas').length);
    
    carregarProdutos();
    carregarVendas();
    
    // Eventos
    $('#produto-select').on('change', function() {
        const produtoId = $(this).val();
        if (produtoId) {
            const produto = produtos.find(p => p.id == produtoId);
            if (produto) {
                $('#quantidade').attr('max', produto.quantidade);
            }
        }
    });
});

function carregarProdutos() {
    console.log('Iniciando carregamento de produtos...');
    $('#status-produtos').html('<i class="fas fa-spinner fa-spin me-2"></i>Carregando produtos...');
    
    $.get('/api/produtos', function(data) {
        console.log('Resposta da API:', data);
        produtos = data;
        
        // Atualizar select
        const select = $('#produto-select');
        select.empty().append('<option value="">Selecione um produto</option>');
        
        produtos.forEach(function(produto) {
            if (produto.quantidade > 0) {
                const option = `<option value="${produto.id}" data-preco="${produto.valor_custo}">${produto.nome} (Estoque: ${produto.quantidade})</option>`;
                select.append(option);
            }
        });
        
        $('#status-produtos').html(`<i class="fas fa-check-circle me-2"></i>${produtos.length} produtos carregados`);
        
        console.log('Produtos carregados com sucesso:', produtos.length);
        
    }).fail(function(xhr, status, error) {
        console.error('Erro ao carregar produtos:', status, error);
        $('#status-produtos').html('<i class="fas fa-exclamation-triangle me-2"></i>Erro ao carregar produtos');
    });
}

function carregarVendas() {
    $.get('/api/vendas', function(data) {
        vendas = data;
        renderizarVendas();
    });
}

function recarregarProdutos() {
    console.log('Recarregando produtos...');
    carregarProdutos();
}

function adicionarProduto() {
    const produtoId = $('#produto-select').val();
    const quantidade = parseInt($('#quantidade').val());
    
    if (!produtoId || !quantidade || quantidade <= 0) {
        alert('Selecione um produto e uma quantidade válida!');
        return;
    }
    
    const produto = produtos.find(p => p.id == produtoId);
    if (!produto) {
        alert('Produto não encontrado!');
        return;
    }
    
    if (quantidade > produto.quantidade) {
        alert(`Quantidade solicitada (${quantidade}) excede o estoque disponível (${produto.quantidade})!`);
        return;
    }
    
    // Verificar se o produto já está na lista
    const produtoExistente = produtosSelecionados.find(p => p.id == produtoId);
    if (produtoExistente) {
        alert('Este produto já foi adicionado à venda!');
        return;
    }
    
    // Adicionar produto à lista
    produtosSelecionados.push({
        id: produtoId,
        nome: produto.nome,
        quantidade: quantidade,
        valor_unitario: produto.valor_custo,
        valor_total: produto.valor_custo * quantidade
    });
    
    atualizarListaProdutos();
    calcularTotalGeral();
    
    // Limpar campos
    $('#produto-select').val('');
    $('#quantidade').val(1);
}

function removerProduto(index) {
    produtosSelecionados.splice(index, 1);
    atualizarListaProdutos();
    calcularTotalGeral();
}

function atualizarListaProdutos() {
    const container = $('#lista-produtos');
    
    if (produtosSelecionados.length === 0) {
        container.html('<p class="text-muted text-center mb-0">Nenhum produto selecionado</p>');
        return;
    }
    
    let html = '';
    produtosSelecionados.forEach(function(produto, index) {
        html += `
            <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                <div>
                    <strong>${produto.nome}</strong><br>
                    <small class="text-muted">${produto.quantidade} x R$ ${produto.valor_unitario.toFixed(2).replace('.', ',')} = R$ ${produto.valor_total.toFixed(2).replace('.', ',')}</small>
                </div>
                <button type="button" class="btn btn-sm btn-danger" onclick="removerProduto(${index})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
    });
    container.html(html);
}

function calcularTotalGeral() {
    const total = produtosSelecionados.reduce((sum, produto) => sum + produto.valor_total, 0);
    $('#total').text('R$ ' + total.toFixed(2).replace('.', ','));
}

function finalizarVenda() {
    if (produtosSelecionados.length === 0) {
        alert('Adicione pelo menos um produto à venda!');
        return;
    }
    
    const tipoPagamento = $('#tipo-pagamento').val();
    if (!tipoPagamento) {
        alert('Selecione o tipo de pagamento!');
        return;
    }
    
    const cliente = $('#cliente').val() || '';
    const total = produtosSelecionados.reduce((sum, produto) => sum + produto.valor_total, 0);
    
    const dados = {
        cliente: cliente,
        tipo_pagamento: tipoPagamento,
        parcelas: 1,
        valor_total: total,
        itens: produtosSelecionados.map(produto => ({
            produto_id: parseInt(produto.id),
            quantidade: produto.quantidade
        }))
    };
    
    console.log('Dados da venda:', dados);
    
    $.ajax({
        url: '/api/vendas',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(dados),
        success: function(response) {
            console.log('Venda registrada:', response);
            alert('Venda registrada com sucesso!');
            
            // Limpar formulário
            produtosSelecionados = [];
            atualizarListaProdutos();
            calcularTotalGeral();
            $('#tipo-pagamento').val('');
            $('#cliente').val('');
            
            carregarVendas(); // Recarregar histórico após nova venda
        },
        error: function(xhr, status, error) {
            console.error('Erro na venda:', xhr.responseText);
            alert('Erro ao registrar venda: ' + error);
        }
    });
}

function renderizarVendas() {
    const tbody = $('#tabela-vendas tbody');
    
    if (vendas.length === 0) {
        tbody.html('<tr><td colspan="5" class="text-center text-muted">Nenhuma venda registrada</td></tr>');
        return;
    }
    
    let html = '';
    vendas.forEach(function(venda) {
        const produtos = venda.produtos.map(p => `${p.nome} (${p.quantidade})`).join(', ');
        const tipoPagamento = venda.tipo_pagamento === 'Parcelamento' && venda.parcelas > 1 
            ? `${venda.tipo_pagamento} (${venda.parcelas}x)` 
            : venda.tipo_pagamento;
        
        html += `
            <tr>
                <td><small>${venda.data_venda}</small></td>
                <td>${venda.cliente || '-'}</td>
                <td><small>${produtos}</small></td>
                <td><strong class="text-success">R$ ${venda.valor_total.toFixed(2).replace('.', ',')}</strong></td>
                <td><span class="badge bg-info">${tipoPagamento}</span></td>
            </tr>
        `;
    });
    tbody.html(html);
}
</script>
{% endblock %}