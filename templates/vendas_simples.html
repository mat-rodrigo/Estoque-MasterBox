{% extends "base.html" %}

{% block title %}Vendas Simples - Sistema de Estoque{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="text-center">
            <i class="fas fa-shopping-cart text-success me-3"></i>
            Vendas Simples
        </h2>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-plus-circle me-2"></i>
                    Nova Venda
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Status do Carregamento:</label>
                    <div id="status-produtos" class="alert alert-info">
                        Carregando produtos...
                    </div>
                    <div id="notificacao-recarregamento" class="alert alert-success" style="display: none;">
                        <i class="fas fa-sync-alt me-2"></i>
                        Estoque atualizado!
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Produto:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="produto-input" autocomplete="off" placeholder="Digite o nome do produto...">
                        <button class="btn btn-outline-secondary" type="button" onclick="limparBuscaProduto()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <ul id="sugestoes-produto" style="position:absolute; z-index:1000; background:white; border:1px solid #ccc; width:100%; list-style:none; padding-left:0;"></ul>
                    <div id="produto-selecionado" class="mt-2" style="display: none;">
                        <div class="alert alert-success">
                            <strong id="nome-produto"></strong><br>
                            <small id="info-produto"></small>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Quantidade:</label>
                    <input type="number" class="form-control" id="quantidade" min="1" value="1">
                </div>
                
                <div class="mb-3">
                    <button type="button" class="btn btn-primary" onclick="adicionarProduto()">
                        <i class="fas fa-plus me-2"></i>
                        Adicionar Produto
                    </button>
                </div>
                
                <hr>
                
                <div class="mb-3">
                    <h6>Produtos Selecionados:</h6>
                    <div id="lista-produtos" class="border rounded p-2" style="min-height: 100px;">
                        <p class="text-muted text-center mb-0">Nenhum produto selecionado</p>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Cliente (Opicional): </label>
                    <input type="text" class="form-control" id="cliente" placeholder="Nome do cliente">
                </div>
                
                <div class="mb-3">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Subtotal: <span id="subtotal" class="text-primary">R$ 0,00</span></h5>
                        </div>
                        <div class="col-md-6">
                            <h5>Desconto: <span id="desconto-valor" class="text-danger">R$ 0,00</span></h5>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <h4>Total: <span id="total" class="text-success">R$ 0,00</span></h4>
                        </div>
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-warning" onclick="abrirModalDesconto()">
                                <i class="fas fa-percentage me-2"></i>Aplicar Desconto
                            </button>
                        </div>
                    </div>
                </div>
                
                <button type="button" class="btn btn-success" onclick="abrirModalPagamento()">
                    <i class="fas fa-credit-card me-2"></i>
                    Finalizar Venda
                </button>
                
                <button type="button" class="btn btn-secondary ms-2" onclick="recarregarProdutos()">
                    <i class="fas fa-sync-alt me-2"></i>
                    Recarregar Produtos
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>
                    Histórico de Vendas
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="tabela-vendas">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Cliente</th>
                                <th>Produtos</th>
                                <th>Valor</th>
                                <th>Pagamento</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin me-2"></i>
                                    Carregando vendas...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Seleção de Pagamento -->
<div class="modal fade" id="modalPagamento" tabindex="-1" aria-labelledby="modalPagamentoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalPagamentoLabel">
                    <i class="fas fa-credit-card me-2"></i>
                    Selecionar Método de Pagamento
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 payment-option" onclick="selecionarPagamento('Dinheiro')">
                            <div class="card-body text-center">
                                <i class="fas fa-money-bill-wave fa-3x text-success mb-3"></i>
                                <h6>Dinheiro</h6>
                                <small class="text-muted">Pagamento à vista</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 payment-option" onclick="selecionarPagamento('Pix')">
                            <div class="card-body text-center">
                                <i class="fas fa-qrcode fa-3x text-primary mb-3"></i>
                                <h6>Pix</h6>
                                <small class="text-muted">Pagamento instantâneo</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 payment-option" onclick="abrirModalCartao()">
                            <div class="card-body text-center">
                                <i class="fas fa-credit-card fa-3x text-info mb-3"></i>
                                <h6>Cartão</h6>
                                <small class="text-muted">Débito ou Crédito</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 payment-option" onclick="abrirModalMultiplos()">
                            <div class="card-body text-center">
                                <i class="fas fa-layer-group fa-3x text-warning mb-3"></i>
                                <h6>Múltiplos Métodos</h6>
                                <small class="text-muted">Combinar formas de pagamento</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Cartão -->
<div class="modal fade" id="modalCartao" tabindex="-1" aria-labelledby="modalCartaoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalCartaoLabel">
                    <i class="fas fa-credit-card me-2"></i>
                    Pagamento com Cartão
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 payment-option" onclick="selecionarPagamento('Cartão de Débito')">
                            <div class="card-body text-center">
                                <i class="fas fa-credit-card fa-2x text-success mb-2"></i>
                                <h6>Débito</h6>
                                <small class="text-muted">Pagamento à vista</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 payment-option" onclick="abrirModalCredito()">
                            <div class="card-body text-center">
                                <i class="fas fa-credit-card fa-2x text-warning mb-2"></i>
                                <h6>Crédito</h6>
                                <small class="text-muted">Parcelado</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Crédito -->
<div class="modal fade" id="modalCredito" tabindex="-1" aria-labelledby="modalCreditoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="modalCreditoLabel">
                    <i class="fas fa-credit-card me-2"></i>
                    Cartão de Crédito
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Número de Parcelas:</label>
                    <select class="form-select" id="parcelas-credito">
                        <option value="1">1x (à vista)</option>
                        <option value="2">2x</option>
                        <option value="3">3x</option>
                        <option value="4">4x</option>
                        <option value="5">5x</option>
                        <option value="6">6x</option>
                    </select>
                </div>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-warning" onclick="selecionarPagamentoCredito()">
                        <i class="fas fa-check me-2"></i>
                        Confirmar Pagamento
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Múltiplos Métodos -->
<div class="modal fade" id="modalMultiplos" tabindex="-1" aria-labelledby="modalMultiplosLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="modalMultiplosLabel">
                    <i class="fas fa-layer-group me-2"></i>
                    Múltiplos Métodos de Pagamento
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6>Métodos de Pagamento:</h6>
                        <button type="button" class="btn btn-sm btn-primary" onclick="adicionarMetodoPagamento()">
                            <i class="fas fa-plus me-1"></i>
                            Adicionar Método
                        </button>
                    </div>
                    <div id="lista-metodos-pagamento">
                        <!-- Métodos serão adicionados aqui dinamicamente -->
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <strong>Total da Venda:</strong> <span id="total-venda-modal">R$ 0,00</span><br>
                    <strong>Total dos Pagamentos:</strong> <span id="total-pagamentos-modal">R$ 0,00</span><br>
                    <strong>Diferença:</strong> <span id="diferenca-pagamentos">R$ 0,00</span>
                </div>
                
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-success" onclick="confirmarMultiplosPagamentos()" id="btn-confirmar-multiplos" disabled>
                        <i class="fas fa-check me-2"></i>
                        Finalizar Venda
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Desconto -->
<div class="modal fade" id="modalDesconto" tabindex="-1" aria-labelledby="modalDescontoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalDescontoLabel">
                    <i class="fas fa-percentage me-2"></i>
                    Aplicar Desconto
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Subtotal da Venda:</label>
                    <h4 class="text-primary" id="subtotal-modal">R$ 0,00</h4>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Tipo de Desconto:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="tipo-desconto" id="desconto-percentual" value="percentual" checked>
                        <label class="form-check-label" for="desconto-percentual">
                            Percentual (%)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="tipo-desconto" id="desconto-valor-fixo" value="valor-fixo">
                        <label class="form-check-label" for="desconto-valor-fixo">
                            Valor Fixo (R$)
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label" id="label-valor-desconto">Valor do Desconto (%):</label>
                    <input type="number" class="form-control" id="valor-desconto" step="0.01" min="0" max="100" value="0">
                    <div class="form-text" id="texto-ajuda-desconto">Digite o percentual de desconto (0-100%)</div>
                </div>
                
                <div class="alert alert-info">
                    <strong>Desconto Aplicado:</strong> <span id="desconto-aplicado">R$ 0,00</span><br>
                    <strong>Total Final:</strong> <span id="total-final">R$ 0,00</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="removerDesconto()">
                    <i class="fas fa-times me-2"></i>Remover Desconto
                </button>
                <button type="button" class="btn btn-warning" onclick="aplicarDesconto()">
                    <i class="fas fa-check me-2"></i>Aplicar Desconto
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let produtos = [];
let vendas = [];
let produtosSelecionados = [];
let metodosPagamento = [];
let totalVenda = 0;
let descontoAplicado = 0;
let tipoDesconto = 'percentual'; // 'percentual' ou 'valor-fixo'
let produtoSelecionado = null;

$(document).ready(function() {
    console.log('=== PÁGINA DE VENDAS SIMPLES CARREGADA ===');
    console.log('jQuery disponível:', typeof $ !== 'undefined');
    console.log('Elementos encontrados:');
    console.log('- #produto-select:', $('#produto-select').length);
    console.log('- #status-produtos:', $('#status-produtos').length);
    console.log('- #tabela-vendas:', $('#tabela-vendas').length);
    
    carregarProdutos(false);
    carregarVendas();

    // Autocomplete do campo de produto
    let timeoutBuscaProduto;
    $('#produto-input').on('input', function() {
        clearTimeout(timeoutBuscaProduto);
        const termo = $(this).val().trim();
        if (termo.length < 2) {
            $('#sugestoes-produto').empty();
            return;
        }
        timeoutBuscaProduto = setTimeout(function() {
            $.get(`/api/produtos/busca?q=${encodeURIComponent(termo)}`, function(produtos) {
                const sugestoes = $('#sugestoes-produto');
                sugestoes.empty();
                produtos.forEach(function(prod) {
                    const li = $('<li></li>')
                        .text(prod.nome + ' (Estoque: ' + prod.quantidade + ')')
                        .css({padding: '4px 8px', cursor: 'pointer'})
                        .on('mousedown', function(e) { // usar mousedown para evitar conflito com blur
                            selecionarProdutoAutocomplete(prod);
                        });
                    sugestoes.append(li);
                });
            });
        }, 200);
    });

    // Esconde sugestões ao clicar fora
    $(document).on('mousedown', function(e) {
        if (!$(e.target).closest('#produto-input, #sugestoes-produto').length) {
            $('#sugestoes-produto').empty();
        }
    });
    
    // Busca automática de produtos
    // let timeoutBuscaProduto; // This line is removed as per the new_code, as the autocomplete handles it.
    // $('#produto-busca').on('input', function() { // This line is removed as per the new_code, as the autocomplete handles it.
    //     clearTimeout(timeoutBuscaProduto); // This line is removed as per the new_code, as the autocomplete handles it.
    //     const busca = $(this).val().trim(); // This line is removed as per the new_code, as the autocomplete handles it.
        
    //     timeoutBuscaProduto = setTimeout(function() { // This line is removed as per the new_code, as the autocomplete handles it.
    //         buscarProdutos(busca); // This line is removed as per the new_code, as the autocomplete handles it.
    //     }, 300); // This line is removed as per the new_code, as the autocomplete handles it.
    // }); // This line is removed as per the new_code, as the autocomplete handles it.
    
    // Adicionar hover effect aos cards de pagamento
    $('.payment-option').hover(
        function() { $(this).addClass('border-primary'); },
        function() { $(this).removeClass('border-primary'); }
    );

    // Eventos para desconto
    $('#valor-desconto').on('input', function() {
        atualizarPreviewDesconto();
    });
    
    $('input[name="tipo-desconto"]').on('change', function() {
        const tipo = $(this).val();
        const input = $('#valor-desconto');
        const label = $('#label-valor-desconto');
        const texto = $('#texto-ajuda-desconto');
        
        if (tipo === 'percentual') {
            input.attr('max', '100');
            label.text('Valor do Desconto (%):');
            texto.text('Digite o percentual de desconto (0-100%)');
        } else {
            input.removeAttr('max');
            label.text('Valor do Desconto (R$):');
            texto.text('Digite o valor fixo do desconto');
        }
        
        atualizarPreviewDesconto();
    });
});

function carregarProdutos(mostrarMensagemRecarregamento = false) {
    console.log('Iniciando carregamento de produtos...');
    
    if (mostrarMensagemRecarregamento) {
        $('#status-produtos').html('<i class="fas fa-sync-alt fa-spin me-2"></i>Recarregando produtos após venda...');
    } else {
        $('#status-produtos').html('<i class="fas fa-spinner fa-spin me-2"></i>Carregando produtos...');
    }
    
    $.get('/api/produtos', function(data) {
        console.log('Resposta da API:', data);
        produtos = data;
        
        if (mostrarMensagemRecarregamento) {
            $('#status-produtos').html(`<i class="fas fa-check-circle me-2"></i>${produtos.length} produtos atualizados após venda`);
            // Remover a mensagem após 3 segundos
            setTimeout(function() {
                $('#status-produtos').html(`<i class="fas fa-check-circle me-2"></i>${produtos.length} produtos carregados`);
            }, 3000);
        } else {
            $('#status-produtos').html(`<i class="fas fa-check-circle me-2"></i>${produtos.length} produtos carregados`);
        }
        
        console.log('Produtos carregados com sucesso:', produtos.length);
        
    }).fail(function(xhr, status, error) {
        console.error('Erro ao carregar produtos:', status, error);
        $('#status-produtos').html('<i class="fas fa-exclamation-triangle me-2"></i>Erro ao carregar produtos');
    });
}

function carregarVendas() {
    console.log('Carregando vendas...');
    $.get('/api/vendas', function(data) {
        console.log('Vendas carregadas:', data);
        vendas = data;
        renderizarVendas();
    }).fail(function(xhr, status, error) {
        console.error('Erro ao carregar vendas:', error);
        console.error('Status:', status);
        console.error('Response:', xhr.responseText);
    });
}

function buscarProdutos(termo) {
    if (!termo) {
        $('#lista-produtos-busca').hide();
        return;
    }
    
    const resultados = produtos.filter(p => 
        p.nome.toLowerCase().includes(termo.toLowerCase()) &&
        p.quantidade > 0
    );
    
    const container = $('#resultados-produtos');
    container.empty();
    
    if (resultados.length === 0) {
        container.append('<div class="list-group-item text-muted">Nenhum produto encontrado</div>');
    } else {
        resultados.forEach(function(produto) {
            const item = `
                <div class="list-group-item list-group-item-action" onclick="selecionarProduto(${produto.id})">
                    <strong>${produto.nome}</strong><br>
                    <small class="text-muted">Estoque: ${produto.quantidade} | Preço: R$ ${produto.valor_custo.toFixed(2).replace('.', ',')}</small>
                </div>
            `;
            container.append(item);
        });
    }
    
    $('#lista-produtos-busca').show();
}

function selecionarProduto(id) {
    produtoSelecionado = produtos.find(p => p.id === id);
    if (produtoSelecionado) {
        $('#nome-produto').text(produtoSelecionado.nome);
        $('#info-produto').text(`Estoque: ${produtoSelecionado.quantidade} | Preço: R$ ${produtoSelecionado.valor_custo.toFixed(2).replace('.', ',')}`);
        $('#produto-selecionado').show();
        $('#lista-produtos-busca').hide();
        $('#produto-busca').val(produtoSelecionado.nome);
        $('#quantidade').attr('max', produtoSelecionado.quantidade);
    }
}

function selecionarProdutoAutocomplete(prod) {
    produtoSelecionado = prod;
    $('#produto-input').val(prod.nome);
    $('#sugestoes-produto').empty();
    $('#nome-produto').text(prod.nome);
    $('#info-produto').text('Estoque: ' + prod.quantidade);
    $('#produto-selecionado').show();
    $('#quantidade').attr('max', prod.quantidade);
}

function limparBuscaProduto() {
    $('#produto-input').val('');
    $('#sugestoes-produto').empty();
    $('#produto-selecionado').hide();
    produtoSelecionado = null;
}

function recarregarProdutos() {
    console.log('Recarregando produtos manualmente...');
    carregarProdutos(false); // false = não mostrar mensagem de recarregamento automático
}

function adicionarProduto() {
    const quantidade = parseInt($('#quantidade').val());
    
    if (!produtoSelecionado || !quantidade || quantidade <= 0) {
        alert('Selecione um produto e uma quantidade válida!');
        return;
    }
    
    if (quantidade > produtoSelecionado.quantidade) {
        alert(`Quantidade solicitada (${quantidade}) excede o estoque disponível (${produtoSelecionado.quantidade})!`);
        return;
    }
    
    // Verificar se o produto já está na lista
    const produtoExistente = produtosSelecionados.find(p => p.id == produtoSelecionado.id);
    if (produtoExistente) {
        alert('Este produto já foi adicionado à venda!');
        return;
    }
    
    // Adicionar produto à lista
    produtosSelecionados.push({
        id: produtoSelecionado.id,
        nome: produtoSelecionado.nome,
        quantidade: quantidade,
        valor_unitario: produtoSelecionado.valor_varejo,
        valor_total: produtoSelecionado.valor_varejo * quantidade
    });
    
    atualizarListaProdutos();
    calcularTotalGeral();
    
    // Limpar campos
    limparBuscaProduto();
    $('#quantidade').val(1);
}

function removerProduto(index) {
    produtosSelecionados.splice(index, 1);
    atualizarListaProdutos();
    calcularTotalGeral();
}

function atualizarListaProdutos() {
    const container = $('#lista-produtos');
    
    if (produtosSelecionados.length === 0) {
        container.html('<p class="text-muted text-center mb-0">Nenhum produto selecionado</p>');
        return;
    }
    
    let html = '';
    produtosSelecionados.forEach(function(produto, index) {
        html += `
            <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                <div>
                    <strong>${produto.nome}</strong><br>
                    <small class="text-muted">${produto.quantidade} x R$ ${produto.valor_unitario.toFixed(2).replace('.', ',')} = R$ ${produto.valor_total.toFixed(2).replace('.', ',')}</small>
                </div>
                <button type="button" class="btn btn-sm btn-danger" onclick="removerProduto(${index})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
    });
    container.html(html);
}

function calcularTotalGeral() {
    totalVenda = produtosSelecionados.reduce((sum, produto) => sum + produto.valor_total, 0);
    const subtotal = totalVenda;
    const totalComDesconto = subtotal - descontoAplicado;
    
    $('#subtotal').text('R$ ' + subtotal.toFixed(2).replace('.', ','));
    $('#desconto-valor').text('R$ ' + descontoAplicado.toFixed(2).replace('.', ','));
    $('#total').text('R$ ' + totalComDesconto.toFixed(2).replace('.', ','));
}

// ===== FUNÇÕES DE DESCONTO =====

function abrirModalDesconto() {
    if (produtosSelecionados.length === 0) {
        alert('Adicione pelo menos um produto à venda!');
        return;
    }
    
    $('#subtotal-modal').text('R$ ' + totalVenda.toFixed(2).replace('.', ','));
    $('#valor-desconto').val(0);
    atualizarPreviewDesconto();
    $('#modalDesconto').modal('show');
}

function atualizarPreviewDesconto() {
    const valorDesconto = parseFloat($('#valor-desconto').val()) || 0;
    const tipo = $('input[name="tipo-desconto"]:checked').val();
    
    let descontoCalculado = 0;
    if (tipo === 'percentual') {
        descontoCalculado = (totalVenda * valorDesconto) / 100;
    } else {
        descontoCalculado = valorDesconto;
    }
    
    const totalFinal = totalVenda - descontoCalculado;
    
    $('#desconto-aplicado').text('R$ ' + descontoCalculado.toFixed(2).replace('.', ','));
    $('#total-final').text('R$ ' + totalFinal.toFixed(2).replace('.', ','));
}

function aplicarDesconto() {
    const valorDesconto = parseFloat($('#valor-desconto').val()) || 0;
    const tipo = $('input[name="tipo-desconto"]:checked').val();
    
    if (valorDesconto < 0) {
        alert('O valor do desconto não pode ser negativo!');
        return;
    }
    
    if (tipo === 'percentual' && valorDesconto > 100) {
        alert('O percentual de desconto não pode ser maior que 100%!');
        return;
    }
    
    if (tipo === 'valor-fixo' && valorDesconto > totalVenda) {
        alert('O desconto não pode ser maior que o valor total da venda!');
        return;
    }
    
    if (tipo === 'percentual') {
        descontoAplicado = (totalVenda * valorDesconto) / 100;
    } else {
        descontoAplicado = valorDesconto;
    }
    
    tipoDesconto = tipo;
    calcularTotalGeral();
    $('#modalDesconto').modal('hide');
    mostrarAlerta('Desconto aplicado com sucesso!', 'success');
}

function removerDesconto() {
    descontoAplicado = 0;
    tipoDesconto = 'percentual';
    calcularTotalGeral();
    $('#modalDesconto').modal('hide');
    mostrarAlerta('Desconto removido!', 'info');
}

// ===== FUNÇÕES DE PAGAMENTO =====

function abrirModalPagamento() {
    if (produtosSelecionados.length === 0) {
        alert('Adicione pelo menos um produto à venda!');
        return;
    }
    
    $('#modalPagamento').modal('show');
}

function selecionarPagamento(tipo) {
    const cliente = $('#cliente').val() || '';
    const valorComDesconto = totalVenda - descontoAplicado;
    
    // Para Dinheiro e Pix, finalizar imediatamente
    if (tipo === 'Dinheiro' || tipo === 'Pix') {
        const dados = {
            cliente: cliente,
            valor_total: valorComDesconto,
            parcelas: 1,
            pagamentos: [{
                tipo_pagamento: tipo,
                valor: valorComDesconto,
                parcelas: 1
            }],
            itens: produtosSelecionados.map(produto => ({
                produto_id: parseInt(produto.id),
                quantidade: produto.quantidade
            })),
            tipo_venda: 'simples'
        };
        
        finalizarVendaComDados(dados);
        return;
    }
    
    // Para Cartão de Débito
    if (tipo === 'Cartão de Débito') {
        const dados = {
            cliente: cliente,
            valor_total: valorComDesconto,
            parcelas: 1,
            pagamentos: [{
                tipo_pagamento: tipo,
                valor: valorComDesconto,
                parcelas: 1
            }],
            itens: produtosSelecionados.map(produto => ({
                produto_id: parseInt(produto.id),
                quantidade: produto.quantidade
            })),
            tipo_venda: 'simples'
        };
        
        finalizarVendaComDados(dados);
        return;
    }
}

function abrirModalCartao() {
    $('#modalPagamento').modal('hide');
    $('#modalCartao').modal('show');
}

function abrirModalCredito() {
    $('#modalCartao').modal('hide');
    $('#modalCredito').modal('show');
}

function selecionarPagamentoCredito() {
    const parcelas = parseInt($('#parcelas-credito').val());
    const cliente = $('#cliente').val() || '';
    const valorComDesconto = totalVenda - descontoAplicado;
    
    const dados = {
        cliente: cliente,
        valor_total: valorComDesconto,
        parcelas: parcelas,
        pagamentos: [{
            tipo_pagamento: 'Cartão de Crédito',
            valor: valorComDesconto,
            parcelas: parcelas
        }],
        itens: produtosSelecionados.map(produto => ({
            produto_id: parseInt(produto.id),
            quantidade: produto.quantidade
        })),
        tipo_venda: 'simples'
    };
    
    finalizarVendaComDados(dados);
}

function abrirModalMultiplos() {
    $('#modalPagamento').modal('hide');
    metodosPagamento = [];
    atualizarListaMetodosPagamento();
    $('#modalMultiplos').modal('show');
}

function adicionarMetodoPagamento() {
    const metodoIndex = metodosPagamento.length;
    const html = `
        <div class="card mb-2 metodo-pagamento-item" data-index="${metodoIndex}">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">Método:</label>
                        <select class="form-select metodo-tipo" onchange="atualizarValorMetodo(${metodoIndex})">
                            <option value="">Selecione...</option>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Pix">Pix</option>
                            <option value="Cartão de Débito">Cartão de Débito</option>
                            <option value="Cartão de Crédito">Cartão de Crédito</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Valor:</label>
                        <input type="number" class="form-control metodo-valor" step="0.01" min="0" onchange="atualizarTotaisMultiplos()" onkeyup="atualizarTotaisMultiplos()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Parcelas:</label>
                        <select class="form-select metodo-parcelas" onchange="atualizarTotaisMultiplos()">
                            <option value="1">1x</option>
                            <option value="2">2x</option>
                            <option value="3">3x</option>
                            <option value="4">4x</option>
                            <option value="5">5x</option>
                            <option value="6">6x</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-danger btn-sm" onclick="removerMetodoPagamento(${metodoIndex})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    $('#lista-metodos-pagamento').append(html);
    metodosPagamento.push({
        tipo_pagamento: '',
        valor: 0,
        parcelas: 1
    });
    
    atualizarTotaisMultiplos();
}

function removerMetodoPagamento(index) {
    $(`.metodo-pagamento-item[data-index="${index}"]`).remove();
    metodosPagamento.splice(index, 1);
    atualizarTotaisMultiplos();
}

function atualizarValorMetodo(index) {
    const tipo = $(`.metodo-pagamento-item[data-index="${index}"] .metodo-tipo`).val();
    const valorInput = $(`.metodo-pagamento-item[data-index="${index}"] .metodo-valor`);
    const parcelasSelect = $(`.metodo-pagamento-item[data-index="${index}"] .metodo-parcelas`);
    
    if (tipo === 'Cartão de Crédito') {
        parcelasSelect.prop('disabled', false);
    } else {
        parcelasSelect.prop('disabled', true);
        parcelasSelect.val('1');
    }
    
    metodosPagamento[index].tipo_pagamento = tipo;
    atualizarTotaisMultiplos();
}

function atualizarTotaisMultiplos() {
    let totalPagamentos = 0;
    
    // Atualizar valores dos métodos
    $('.metodo-pagamento-item').each(function() {
        const index = $(this).data('index');
        const valor = parseFloat($(this).find('.metodo-valor').val()) || 0;
        const tipo = $(this).find('.metodo-tipo').val();
        const parcelas = parseInt($(this).find('.metodo-parcelas').val()) || 1;
        
        metodosPagamento[index] = {
            tipo_pagamento: tipo,
            valor: valor,
            parcelas: parcelas
        };
        
        totalPagamentos += valor;
    });
    
    const valorComDesconto = totalVenda - descontoAplicado;
    const diferenca = valorComDesconto - totalPagamentos;
    
    $('#total-venda-modal').text('R$ ' + valorComDesconto.toFixed(2).replace('.', ','));
    $('#total-pagamentos-modal').text('R$ ' + totalPagamentos.toFixed(2).replace('.', ','));
    $('#diferenca-pagamentos').text('R$ ' + diferenca.toFixed(2).replace('.', ','));
    
    // Habilitar/desabilitar botão de confirmar
    const btnConfirmar = $('#btn-confirmar-multiplos');
    if (Math.abs(diferenca) < 0.01 && metodosPagamento.length > 0 && metodosPagamento.every(m => m.tipo_pagamento && m.valor > 0)) {
        btnConfirmar.prop('disabled', false);
        $('#diferenca-pagamentos').removeClass('text-danger').addClass('text-success');
    } else {
        btnConfirmar.prop('disabled', true);
        $('#diferenca-pagamentos').removeClass('text-success').addClass('text-danger');
    }
}

function atualizarListaMetodosPagamento() {
    $('#lista-metodos-pagamento').empty();
    metodosPagamento = [];
    atualizarTotaisMultiplos();
}

function confirmarMultiplosPagamentos() {
    const cliente = $('#cliente').val() || '';
    const valorComDesconto = totalVenda - descontoAplicado;
    
    const dados = {
        cliente: cliente,
        valor_total: valorComDesconto,
        parcelas: 1,
        pagamentos: metodosPagamento.filter(m => m.tipo_pagamento && m.valor > 0),
        itens: produtosSelecionados.map(produto => ({
            produto_id: parseInt(produto.id),
            quantidade: produto.quantidade
        })),
        tipo_venda: 'simples'
    };
    
    finalizarVendaComDados(dados);
}

function finalizarVendaComDados(dados) {
    console.log('Dados da venda:', dados);
    
    $.ajax({
        url: '/api/vendas',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(dados),
        success: function(response) {
            console.log('Venda registrada:', response);
            alert('Venda registrada com sucesso!');
            
            // Fechar todos os modais
            $('.modal').modal('hide');
            
            // Limpar formulário
            produtosSelecionados = [];
            atualizarListaProdutos();
            descontoAplicado = 0;
            tipoDesconto = 'percentual';
            calcularTotalGeral();
            $('#cliente').val('');
            
            // Recarregar produtos automaticamente após venda finalizada
            console.log('Recarregando produtos após venda...');
            carregarProdutos(true);
            
            // Mostrar notificação de recarregamento automático
            mostrarNotificacaoRecarregamento();
            
            carregarVendas(); // Recarregar histórico após nova venda
        },
        error: function(xhr, status, error) {
            console.error('Erro na venda:', xhr.responseText);
            alert('Erro ao registrar venda: ' + error);
        }
    });
}

function renderizarVendas() {
    console.log('Renderizando vendas...');
    console.log('Vendas:', vendas);
    console.log('Tabela encontrada:', $('#tabela-vendas').length);
    
    const tbody = $('#tabela-vendas tbody');
    console.log('Tbody encontrado:', tbody.length);
    
    if (vendas.length === 0) {
        console.log('Nenhuma venda encontrada');
        tbody.html('<tr><td colspan="5" class="text-center text-muted">Nenhuma venda registrada</td></tr>');
        return;
    }
    
    let html = '';
    vendas.forEach(function(venda, index) {
        console.log(`Processando venda ${index}:`, venda);
        const produtos = venda.produtos.map(p => `${p.nome} (${p.quantidade})`).join(', ');
        
        // Preparar string dos métodos de pagamento
        let pagamentosStr = '';
        if (venda.pagamentos && venda.pagamentos.length > 0) {
            pagamentosStr = venda.pagamentos.map(p => {
                if (p.tipo_pagamento === 'Cartão de Crédito' && p.parcelas > 1) {
                    return `${p.tipo_pagamento} (${p.parcelas}x) - R$ ${p.valor.toFixed(2).replace('.', ',')}`;
                } else {
                    return `${p.tipo_pagamento} - R$ ${p.valor.toFixed(2).replace('.', ',')}`;
                }
            }).join(', ');
        } else {
            pagamentosStr = 'N/A';
        }
        
        html += `
            <tr>
                <td><small>${venda.data_venda}</small></td>
                <td>${venda.cliente || '-'}</td>
                <td><small>${produtos}</small></td>
                <td><strong class="text-success">R$ ${venda.valor_total.toFixed(2).replace('.', ',')}</strong></td>
                <td><span class="badge bg-info">${pagamentosStr}</span></td>
            </tr>
        `;
    });
    
    console.log('HTML gerado:', html);
    tbody.html(html);
    console.log('Vendas renderizadas com sucesso');
}

function mostrarNotificacaoRecarregamento() {
    const notificacao = $('#notificacao-recarregamento');
    notificacao.fadeIn();
    
    // Ocultar a notificação após 5 segundos
    setTimeout(function() {
        notificacao.fadeOut();
    }, 5000);
}
</script>

<style>
.payment-option {
    cursor: pointer;
    transition: all 0.3s ease;
}

.payment-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.metodo-pagamento-item {
    border: 1px solid #dee2e6;
}
</style>
{% endblock %}